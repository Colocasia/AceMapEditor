# AceMapEditor 项目文档

## 技术栈

**平台**: Unity Editor Extension（插件形式）
**语言**: C#
**渲染管线**: Universal Render Pipeline (URP)
**Unity版本**: 2021.3 LTS 或更高
**架构原则**: 分层架构，核心逻辑与引擎解耦
**Package管理**: Unity Package Manager (UPM)

---

## 项目组织方式

### UPM Package结构

本项目采用 **Unity Package Manager (UPM)** 方式组织代码，具备以下优势：

- ✅ **模块化管理**：独立于具体Unity项目
- ✅ **版本控制**：支持语义化版本管理
- ✅ **多项目复用**：可在多个Unity项目中共享
- ✅ **易于发布**：可发布到Git仓库或UPM Registry
- ✅ **依赖管理**：清晰的依赖关系定义

### Package目录结构

采用**引擎分层结构**，核心逻辑与Unity实现完全分离，便于未来扩展到其他引擎（如Godot）：

```
AceMapEditor/                           # Package根目录
├── package.json                        # UPM配置文件
├── README.md                           # Package说明文档
├── CHANGELOG.md                        # 版本变更记录
├── LICENSE.md                          # MIT许可证
├── CLAUDE.md                           # 开发指南
│
├── AceMapEditor.Core/                  # 核心逻辑层（引擎无关）
│   ├── AceMapEditor.Core.asmdef        # Assembly Definition
│   ├── Interfaces/                     # 引擎抽象接口
│   │   ├── ITerrainAdapter.cs
│   │   ├── ISceneAdapter.cs
│   │   └── IResourceAdapter.cs
│   ├── Data/                           # 数据模型
│   │   ├── MapData.cs
│   │   ├── TerrainData.cs
│   │   └── UnitData.cs
│   ├── Editor/                         # 编辑器逻辑（纯C#）
│   │   ├── Terrain/
│   │   ├── Units/
│   │   └── Triggers/
│   ├── Serialization/                  # 序列化
│   └── Utilities/                      # 工具类
│
├── AceMapEditor.Unity/                 # Unity实现层
│   ├── Editor/                         # Unity编辑器扩展
│   │   ├── AceMapEditor.Editor.asmdef
│   │   ├── Adapters/                   # Unity适配器实现
│   │   │   ├── UnityTerrainAdapter.cs
│   │   │   ├── UnitySceneAdapter.cs
│   │   │   └── UnityResourceAdapter.cs
│   │   ├── Windows/                    # 编辑器窗口
│   │   │   ├── AceMapEditorWindow.cs
│   │   │   ├── TerrainEditorWindow.cs
│   │   │   └── TriggerEditorWindow.cs
│   │   ├── Tools/                      # SceneView工具
│   │   ├── Inspectors/                 # 自定义Inspector
│   │   └── SceneView/                  # SceneView扩展
│   │
│   ├── Runtime/                        # Unity运行时
│   │   ├── AceMapEditor.Runtime.asmdef
│   │   └── Components/                 # MonoBehaviour组件
│   │
│   ├── Shaders/                        # URP Shader
│   │   └── TerrainBlend.shader
│   │
│   ├── Resources/                      # Unity资源
│   │   ├── Definitions/
│   │   │   ├── Units/
│   │   │   ├── Abilities/
│   │   │   └── Doodads/
│   │   ├── Textures/
│   │   └── Prefabs/
│   │
│   └── Tests/                          # 单元测试
│       ├── Editor/
│       │   └── AceMapEditor.Tests.Editor.asmdef
│       └── Runtime/
│           └── AceMapEditor.Tests.Runtime.asmdef
│
└── Docs/                               # 项目文档
    ├── 需求文档.md
    ├── 项目文档.md
    └── 代码规范.md

# 未来扩展（示例）
# └── AceMapEditor.Godot/             # Godot实现层（未来）
#     ├── Editor/
#     │   ├── Adapters/
#     │   │   ├── GodotTerrainAdapter.cs
#     │   │   └── GodotSceneAdapter.cs
#     │   └── Windows/
#     └── Runtime/
```

### 目录结构设计说明

#### 1. **AceMapEditor.Core/** - 核心逻辑层
- **完全引擎无关**：不依赖Unity、Godot等任何引擎
- **纯C#实现**：可在任何.NET环境运行
- **接口驱动**：通过接口定义引擎能力，具体实现由各引擎层提供
- **高性能优化**：支持unsafe代码、struct、指针等高性能特性
- **Assembly配置**：`noEngineReferences: true`，禁止引用Unity引擎

#### 2. **AceMapEditor.Unity/** - Unity实现层
- **Unity特定代码**：所有Unity相关的API调用都在这里
- **适配器实现**：实现Core层定义的接口，桥接Unity API
- **编辑器扩展**：EditorWindow、SceneView、Inspector等
- **运行时组件**：MonoBehaviour、ScriptableObject等
- **URP资源**：Shader、材质、预制体等

#### 3. **未来扩展性**
- 添加Godot支持：只需新建 `AceMapEditor.Godot/` 目录
- 实现Godot的Adapter层
- Core层代码无需任何修改，直接复用
- 不同引擎实现可以共存

### Assembly Definition说明

项目使用Assembly Definition (.asmdef)实现模块隔离和编译优化：

#### 1. **AceMapEditor.Core**
```json
{
  "name": "AceMapEditor.Core",
  "allowUnsafeCode": true,
  "noEngineReferences": true  // 不引用Unity引擎
}
```
- **职责**：引擎无关的核心逻辑
- **特点**：完全可移植，支持unsafe代码（性能优化）
- **依赖**：无Unity引擎依赖

#### 2. **AceMapEditor.Runtime**
```json
{
  "name": "AceMapEditor.Runtime",
  "references": ["AceMapEditor.Core"],
  "allowUnsafeCode": true
}
```
- **职责**：运行时组件（如果需要）
- **依赖**：Core模块

#### 3. **AceMapEditor.Editor**
```json
{
  "name": "AceMapEditor.Editor",
  "references": ["AceMapEditor.Core", "AceMapEditor.Runtime"],
  "includePlatforms": ["Editor"],
  "allowUnsafeCode": true
}
```
- **职责**：编辑器扩展和Unity适配器
- **平台**：仅Editor平台
- **依赖**：Core + Runtime

#### 4. **测试Assembly**
- `AceMapEditor.Tests.Editor`：编辑器测试
- `AceMapEditor.Tests.Runtime`：运行时测试

### 使用方式

#### 方式1：Git URL安装（推荐）
```bash
# 在Unity Package Manager中
Add package from git URL...
输入：https://github.com/Colocasia/AceMapEditor.git
```

#### 方式2：本地Package
```json
// 在Unity项目的 Packages/manifest.json 中添加
{
  "dependencies": {
    "com.colocasia.acemapeditor": "file:/path/to/AceMapEditor"
  }
}
```

#### 方式3：复制到Packages目录
```bash
# 直接复制整个文件夹到Unity项目的Packages目录
YourUnityProject/Packages/AceMapEditor/
```

### 版本管理

版本号遵循 **语义化版本 2.0.0** 规范：

```
主版本号.次版本号.修订号 (MAJOR.MINOR.PATCH)

例如：0.1.0
- 0: 主版本（不兼容的API变更）
- 1: 次版本（向后兼容的功能新增）
- 0: 修订号（向后兼容的问题修正）
```

在 `package.json` 和 `CHANGELOG.md` 中同步更新版本信息。

---

## 系统架构

### 整体架构概览

```
┌────────────────────────────────────────────────────────────┐
│                   Unity Editor Layer                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ EditorWindow │  │  SceneView   │  │ Inspector UI │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
└─────────┼──────────────────┼──────────────────┼────────────┘
          │                  │                  │
┌─────────▼──────────────────▼──────────────────▼────────────┐
│                  Presentation Layer                         │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐ │
│  │ TerrainToolVM  │  │  UnitToolVM    │  │ TriggerVM    │ │
│  └────────┬───────┘  └────────┬───────┘  └──────┬───────┘ │
└───────────┼────────────────────┼──────────────────┼─────────┘
            │                    │                  │
┌───────────▼────────────────────▼──────────────────▼─────────┐
│                  Business Logic Layer                        │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐ │
│  │ TerrainEditor  │  │  UnitManager   │  │TriggerSystem │ │
│  │ SplatMapMgr    │  │  RegionManager │  │VariablesMgr  │ │
│  └────────┬───────┘  └────────┬───────┘  └──────┬───────┘ │
└───────────┼────────────────────┼──────────────────┼─────────┘
            │                    │                  │
┌───────────▼────────────────────▼──────────────────▼─────────┐
│              Engine Abstraction Layer (接口)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ITerrainAdap  │  │ ISceneAdap   │  │IResourceAdap │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
└─────────┼──────────────────┼──────────────────┼─────────────┘
          │                  │                  │
┌─────────▼──────────────────▼──────────────────▼─────────────┐
│                  Unity Implementation                        │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐ │
│  │UnityTerrainAdp │  │ UnitySceneAdp  │  │UnityResource │ │
│  │  (Mesh/Shader) │  │  (GameObject)  │  │(AssetDB)     │ │
│  └────────────────┘  └────────────────┘  └──────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

### 分层职责说明

#### 1. Unity Editor Layer（Unity特定层）
**职责**：
- 编辑器窗口UI（EditorWindow、IMGUI/UIElements）
- 场景视图交互（SceneView、Handles、Gizmos）
- Inspector面板（CustomEditor）

**特点**：
- Unity特定代码
- 不可移植
- 负责用户交互和可视化

#### 2. Presentation Layer（表示层）
**职责**：
- 管理UI状态（ViewModel）
- 处理用户输入
- 调用业务逻辑层
- 数据绑定和更新

**特点**：
- 可移植（纯C#）
- 不包含Unity特定类型
- MVVM模式

#### 3. Business Logic Layer（业务逻辑层）
**职责**：
- 核心编辑器逻辑
- 数据管理和验证
- 算法实现（地形计算、权重归一化等）
- 调用引擎抽象层

**特点**：
- 完全可移植
- 引擎无关
- 可单元测试

#### 4. Engine Abstraction Layer（引擎抽象层）
**职责**：
- 定义引擎操作接口
- 隔离引擎依赖
- 提供统一API

**特点**：
- 纯接口定义
- 可替换实现（Unity→Godot）

#### 5. Unity Implementation Layer（Unity实现层）
**职责**：
- 实现引擎抽象接口
- 与Unity引擎交互
- 性能优化

**特点**：
- Unity特定
- 可替换（移植时重写）

---

### 模块依赖关系

```
┌──────────────────────────────────────────────────┐
│                   Editor                         │
│  ┌──────────────┐       ┌──────────────┐       │
│  │   Windows    │──────▶│   Tools      │       │
│  └──────┬───────┘       └──────┬───────┘       │
│         │                      │                │
│         │    ┌─────────────────┘                │
│         ▼    ▼                                  │
│  ┌──────────────┐       ┌──────────────┐       │
│  │  SceneView   │       │  Adapters    │       │
│  └──────┬───────┘       └──────┬───────┘       │
└─────────┼──────────────────────┼────────────────┘
          │                      │
          ▼                      ▼
┌──────────────────────────────────────────────────┐
│                    Core                          │
│  ┌──────────────┐       ┌──────────────┐       │
│  │ Interfaces   │◀──────│   Editor     │       │
│  └──────────────┘       └──────┬───────┘       │
│                                 │                │
│  ┌──────────────┐       ┌──────▼───────┐       │
│  │     Data     │◀──────│Serialization │       │
│  └──────────────┘       └──────────────┘       │
│                                                  │
│  ┌──────────────┐                               │
│  │  Utilities   │                               │
│  └──────────────┘                               │
└──────────────────────────────────────────────────┘

依赖规则：
• Editor → Core (允许)
• Core → Editor (禁止)
• Core → UnityEngine (禁止)
• Adapters → Core.Interfaces (允许)
```

---

### 数据流设计

#### 地形编辑数据流

```
用户操作
   │
   ▼
[TerrainToolWindow]  ─────────────┐
   │                              │
   │ 1. 捕获鼠标输入              │
   ▼                              │
[SceneViewIntegration]            │
   │                              │
   │ 2. 转换为世界坐标            │ 5. 更新UI
   ▼                              │
[TexturePaintTool]                │
   │                              │
   │ 3. 计算笔刷影响范围          │
   ▼                              ▲
[SplatMapManager]                 │
   │                              │
   │ 4. 更新权重图                │
   ▼                              │
[ITextureBlendAdapter] ───────────┘
   │
   │ 5. 应用到GPU
   ▼
[UnityTextureBlendAdapter]
   │
   │ 6. 更新纹理
   ▼
[Texture2D.Apply()]
```

#### 地图保存数据流

```
[EditorWindow]
   │ 用户点击保存
   ▼
[MapSerializer]
   │ 收集数据
   ├──────────────┬──────────────┬──────────────┐
   ▼              ▼              ▼              ▼
[TerrainEditor] [UnitManager] [TriggerSystem] [RegionManager]
   │              │              │              │
   │ 导出数据     │ 导出数据     │ 导出数据     │ 导出数据
   ▼              ▼              ▼              ▼
[TerrainData]  [UnitData[]]  [TriggerData[]] [RegionData[]]
   │              │              │              │
   └──────────────┴──────────────┴──────────────┘
                  │
                  ▼
          [MapData (聚合)]
                  │
                  ▼
         [JSON序列化]
                  │
                  ▼
         [写入.acemap文件]
```

---

### 核心系统架构

#### 地形系统架构

```
┌─────────────────────────────────────────────────────┐
│              Terrain System                         │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────┐      ┌──────────────┐           │
│  │TerrainEditor │      │HeightMapMgr  │           │
│  │              │      │              │           │
│  │- RaiseTerrain│      │- GetHeight   │           │
│  │- LowerTerrain│      │- SetHeight   │           │
│  │- Smooth      │      │- Normalize   │           │
│  └──────┬───────┘      └──────┬───────┘           │
│         │                     │                    │
│         │  ┌──────────────────┘                    │
│         ▼  ▼                                       │
│  ┌──────────────┐      ┌──────────────┐           │
│  │SplatMapMgr   │      │TerrainMesh   │           │
│  │              │      │Generator     │           │
│  │- SetWeight   │      │              │           │
│  │- GetWeight   │      │- Generate    │           │
│  │- Normalize   │      │- UpdateMesh  │           │
│  │- Apply       │      │- CalcNormals │           │
│  └──────┬───────┘      └──────┬───────┘           │
│         │                     │                    │
└─────────┼─────────────────────┼─────────────────────┘
          │                     │
          ▼                     ▼
┌─────────────────────────────────────────────────────┐
│            Engine Abstraction                       │
│  ┌──────────────────┐  ┌────────────────────┐     │
│  │ITextureBlendAdap │  │ ITerrainMeshAdap   │     │
│  └──────────────────┘  └────────────────────┘     │
└─────────────────────────────────────────────────────┘
          │                     │
          ▼                     ▼
┌─────────────────────────────────────────────────────┐
│            Unity Implementation                     │
│  ┌──────────────────┐  ┌────────────────────┐     │
│  │UnityTexBlendAdap │  │ UnityMeshAdapter   │     │
│  │                  │  │                    │     │
│  │- Material        │  │- Mesh              │     │
│  │- Splatmap[]      │  │- MeshFilter        │     │
│  │- Shader          │  │- MeshRenderer      │     │
│  └──────────────────┘  └────────────────────┘     │
└─────────────────────────────────────────────────────┘
```

#### 触发器系统架构

```
┌─────────────────────────────────────────────────────┐
│            Trigger System                           │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────────────────────┐              │
│  │      TriggerManager              │              │
│  │                                  │              │
│  │  - triggers: List<Trigger>       │              │
│  │  - Execute()                     │              │
│  │  - Add/Remove()                  │              │
│  └──────────┬───────────────────────┘              │
│             │                                       │
│             │ 包含多个                              │
│             ▼                                       │
│  ┌──────────────────────────────────┐              │
│  │         Trigger                  │              │
│  │                                  │              │
│  │  - events: TriggerEvent[]        │              │
│  │  - conditions: Condition[]       │              │
│  │  - actions: TriggerAction[]      │              │
│  │  - CheckAndExecute()             │              │
│  └──┬───────┬───────────┬───────────┘              │
│     │       │           │                          │
│     │       │           │                          │
├─────┼───────┼───────────┼──────────────────────────┤
│     ▼       ▼           ▼                          │
│  ┌────┐ ┌────────┐ ┌────────┐                     │
│  │Event│ │Condition│ │Action  │  抽象基类          │
│  └──┬─┘ └───┬────┘ └───┬────┘                     │
│     │       │          │                           │
├─────┼───────┼──────────┼───────────────────────────┤
│     │       │          │       具体实现            │
│     ▼       ▼          ▼                           │
│  ┌────────────────────────────────┐               │
│  │ GameStartEvent                 │               │
│  │ UnitEnterRegionEvent           │               │
│  │ TimerEvent                     │               │
│  └────────────────────────────────┘               │
│                                                    │
│  ┌────────────────────────────────┐               │
│  │ CompareIntCondition            │               │
│  │ UnitStateCondition             │               │
│  └────────────────────────────────┘               │
│                                                    │
│  ┌────────────────────────────────┐               │
│  │ CreateUnitAction               │               │
│  │ DisplayMessageAction           │               │
│  │ ModifyVariableAction           │               │
│  └────────────────────────────────┘               │
│                                                    │
│  ┌────────────────────────────────┐               │
│  │   VariableManager              │               │
│  │                                │               │
│  │   - globalVars: Dict           │               │
│  │   - Set/Get()                  │               │
│  └────────────────────────────────┘               │
└─────────────────────────────────────────────────────┘
```

---

### 关键技术决策

#### 决策1：不使用Unity Terrain
**原因**：
- 图层数量限制（最多32层）
- Shader定制困难
- 数据格式Unity特定，不利于移植

**方案**：
- 自定义Mesh地形
- Splatmap权重图系统
- URP自定义Shader

**权衡**：
- 优势：完全控制、无限图层、可移植
- 劣势：需要自己实现所有功能

#### 决策2：分层架构
**原因**：
- 支持未来迁移到Godot
- 核心逻辑可复用
- 便于单元测试

**方案**：
- Core层完全引擎无关
- 通过接口抽象引擎操作
- 数据层使用纯C#类型

**权衡**：
- 优势：可移植性、可测试性
- 劣势：开发复杂度增加

#### 决策3：使用Struct优化性能
**原因**：
- 地形系统涉及大量小型数据（顶点、权重等）
- 减少GC压力
- 提升缓存命中率

**方案**：
- Vector3f、TerrainVertex等用readonly struct
- NativeArray处理大批量数据
- Span<T>用于临时缓冲区

**权衡**：
- 优势：性能提升、内存效率
- 劣势：需要注意struct复制问题

#### 决策4：事件-条件-动作触发器模型
**原因**：
- 参考星际2银河编辑器成熟方案
- 灵活可扩展
- 易于理解和使用

**方案**：
- 抽象基类 + 具体实现
- 支持自定义扩展
- 可视化编辑器

**权衡**：
- 优势：功能强大、易扩展
- 劣势：实现复杂度较高

---

### 模块交互时序

#### 场景：用户绘制地形纹理

```
用户        TerrainTool    SceneView    SplatMapMgr    Adapter      Unity
 │              │              │              │           │           │
 │ 鼠标按下     │              │              │           │           │
 ├──────────────▶              │              │           │           │
 │              │ OnMouseDown  │              │           │           │
 │              ├──────────────▶              │           │           │
 │              │              │ 射线检测     │           │           │
 │              │              ├──────────────┼───────────┼──────────▶│
 │              │              │              │           │ 返回命中点│
 │              │              ◀──────────────┼───────────┼───────────┤
 │              │ Paint(pos)   │              │           │           │
 │              ├──────────────┼──────────────▶           │           │
 │              │              │              │ SetWeight │           │
 │              │              │              ├───────────▶           │
 │              │              │              │ Normalize │           │
 │              │              │              ├───────────▶           │
 │              │              │              │ Apply     │           │
 │              │              │              ├───────────▶           │
 │              │              │              │           │UpdateTexture
 │              │              │              │           ├──────────▶│
 │              │              │              │           │           │
 │ 鼠标拖拽     │              │              │           │           │
 ├──────────────▶              │              │           │           │
 │              │ OnMouseDrag  │              │           │           │
 │              ├──────────────▶              │           │           │
 │              │              │... (重复上述流程)        │           │
 │              │              │              │           │           │
 │ 鼠标松开     │              │              │           │           │
 ├──────────────▶              │              │           │           │
 │              │ OnMouseUp    │              │           │           │
 │              ├──────────────▶              │           │           │
 │              │              │ Repaint      │           │           │
 │              │              ├──────────────┼───────────┼──────────▶│
```

---

### 可移植性实现

#### Unity实现示例

```
Core/Interfaces/ITerrainAdapter.cs
    ↓ 定义接口
Editor/Adapters/UnityTerrainAdapter.cs
    ↓ Unity实现
使用Unity Mesh、Material等
```

#### 未来Godot实现

```
Core/Interfaces/ITerrainAdapter.cs
    ↓ 相同接口
Godot/Adapters/GodotTerrainAdapter.cs
    ↓ Godot实现
使用Godot MeshInstance、ShaderMaterial等
```

**核心逻辑层无需修改**，只需替换适配器实现。

---

## 项目结构

```
AceMapEditor/
├── Editor/                          # Unity编辑器代码
│   ├── Windows/                     # 编辑器窗口
│   ├── Tools/                       # 编辑器工具
│   ├── Inspectors/                  # 自定义Inspector
│   ├── SceneView/                   # SceneView集成
│   └── Adapters/                    # Unity适配器
├── Runtime/                         # 运行时代码
├── Core/                            # 核心逻辑（引擎无关）
│   ├── Interfaces/                  # 引擎抽象接口
│   ├── Data/                        # 数据模型
│   ├── Editor/                      # 编辑器逻辑
│   ├── Serialization/               # 序列化
│   └── Utilities/                   # 工具类
├── Shaders/                         # URP Shader文件
├── Resources/                       # 资源文件
│   ├── Definitions/                 # ScriptableObject定义
│   └── Textures/
└── Tests/                           # 测试代码
```

---

## 核心系统技术方案

### 1. 地形系统

#### 技术选型
- **不使用** Unity Terrain系统
- **使用** 自定义Mesh + URP Shader

#### 核心组件
- **SplatMapManager**: 权重图管理，支持无限纹理图层
- **TerrainMeshRenderer**: Mesh渲染
- **TexturePaintTool**: 纹理绘制工具
- **TerrainBlend.shader**: URP自定义Shader

#### Splatmap权重图系统
- 每张Splatmap（RGBA纹理）存储4层纹理权重
- 支持无限图层：每增加4层添加一张Splatmap
- 权重归一化：每像素所有图层权重总和=1

#### URP Shader特性
- 多层纹理混合
- 高度混合算法（避免"泥状"效果）
- RNM法线混合
- PBR材质支持
- 完整光照和阴影

#### 多层纹理融合系统

##### 设计参考：星际2银河编辑器

星际2的地形融合系统有以下核心特点：

1. **双层限制机制**
   - 任意位置最多同时显示2层纹理
   - 绘制新纹理时自动移除最旧的纹理层
   - 通过优先级系统管理纹理叠加顺序

2. **分块存储结构**
   - 地形划分为32x32的Section
   - 每个Section独立存储混合图数据
   - 使用t3TextureMasks格式存储权重信息

3. **纹理调色板系统**
   - 全局8纹理调色板
   - 每个位置引用调色板索引
   - 便于全局纹理替换

4. **基于高度的混合**
   - 利用纹理高度信息实现自然过渡
   - 高海拔纹理优先显示在高处
   - 避免"泥状混合"效果

##### 我们的融合系统设计

基于SC2的经验，结合Unity URP的特性，设计如下系统：

###### 1. 分层混合架构

```
TerrainBlendSystem
├── GlobalTextureLibrary (全局纹理库，最多16种纹理)
├── SectionManager (地形分块管理器)
│   └── TerrainSection (32x32或64x64)
│       ├── ActiveLayers[] (当前激活的纹理层，最多4层)
│       ├── BlendWeights (混合权重图)
│       └── LayerPriority (层优先级列表)
└── BlendAlgorithm (混合算法)
    ├── HeightBasedBlend (基于高度混合)
    └── WeightNormalization (权重归一化)
```

###### 2. 自动融合机制

**绘制流程**：

1. **笔刷绘制阶段**
   - 用户选择纹理并在地形上绘制
   - 计算受影响的Section范围
   - 对每个受影响的像素点执行融合

2. **层管理阶段**
   ```
   对于每个绘制点：
   IF 当前纹理已存在于该点的激活层
       增加该层权重
   ELSE IF 激活层数 < 最大层数(4)
       添加新层到激活层列表
   ELSE
       移除优先级最低的层
       添加新层
   END IF
   ```

3. **权重归一化阶段**
   - 计算所有激活层的总权重
   - 归一化：每层权重 /= 总权重
   - 确保权重总和 = 1.0

4. **高度混合优化**
   - 读取纹理的高度信息（从法线贴图Alpha或专用高度图）
   - 根据高度调整混合权重
   ```
   adjustedWeight = originalWeight * pow(height, heightBlendPower)
   ```
   - 再次归一化权重

###### 3. 层优先级管理

**优先级计算因素**：
- 最后绘制时间（时间戳）
- 累计权重（总覆盖面积）
- 用户指定优先级（可选）

**优先级排序**：
```
Priority = TimeStamp * 0.5 + AccumulatedWeight * 0.3 + UserPriority * 0.2
```

当需要移除旧层时，移除优先级最低的层。

###### 4. Splatmap存储方案

**方案A：固定4层Splatmap（简单高效）**
- 每个Section使用1张RGBA纹理
- R、G、B、A分别存储4层权重
- 超过4层时自动替换最低优先级层
- 优点：GPU采样效率高，实现简单
- 缺点：最多4层纹理

**方案B：动态多Splatmap（灵活扩展）**
- 每个Section使用多张RGBA纹理
- 支持8层、12层或更多
- 通过Shader动态采样多张Splatmap
- 优点：支持更多层
- 缺点：性能开销更大

**推荐方案**：初期使用方案A，后期根据需求升级到方案B

###### 5. 基于高度的混合算法（Shader实现）

在TerrainBlend.shader中实现：

```hlsl
// 伪代码示意
float4 BlendTextures(float2 uv, float4 weights, float4 heights)
{
    // 1. 高度调整权重
    float4 adjustedWeights = weights * pow(heights, _HeightBlendPower);

    // 2. 归一化
    float totalWeight = dot(adjustedWeights, float4(1,1,1,1));
    adjustedWeights /= totalWeight;

    // 3. 混合颜色
    float4 color = 0;
    color += SAMPLE_TEXTURE2D(_Tex0, uv) * adjustedWeights.r;
    color += SAMPLE_TEXTURE2D(_Tex1, uv) * adjustedWeights.g;
    color += SAMPLE_TEXTURE2D(_Tex2, uv) * adjustedWeights.b;
    color += SAMPLE_TEXTURE2D(_Tex3, uv) * adjustedWeights.a;

    return color;
}
```

###### 6. 实时预览优化

- **笔刷预览**：实时显示当前笔刷影响范围
- **权重可视化**：可切换到权重显示模式查看混合情况
- **图层隔离**：可单独显示某一层纹理
- **混合强度控制**：笔刷强度参数控制绘制速度

---

### 2. 单位系统

#### 数据结构
- **UnitData**: 单位实例数据（位置、属性、所属玩家）
- **UnitDefinition**: 单位定义（ScriptableObject）

#### 核心功能
- 单位放置和删除
- 单位属性编辑
- 单位分组管理

---

### 3. 触发器系统

#### 核心架构
- **TriggerEvent**: 事件基类
- **TriggerCondition**: 条件基类
- **TriggerAction**: 动作基类
- **Trigger**: 触发器（事件-条件-动作）

#### 特性
- 支持自定义事件、条件、动作
- 变量系统（全局/局部）
- 函数和自定义动作

---

### 4. 区域系统

#### 区域类型
- 矩形区域
- 圆形区域
- 多边形区域

#### 功能
- 区域绘制和编辑
- 触发器区域事件
- 视野控制

---

### 5. 数据编辑器

#### 数据类型
- 单位定义
- 技能定义
- 装饰物定义

#### 存储方式
使用 ScriptableObject 进行数据配置

---

## 文件格式

### 地图文件（.acemap）

使用JSON格式存储：
- 地图信息
- 地形数据（高度图、纹理层）
- 单位列表
- 触发器列表
- 区域列表
- 玩家配置

---

## 性能优化策略

1. **纹理压缩**: 运行时使用BC7/DXT5
2. **延迟更新**: 批处理，减少GPU调用
3. **LOD系统**: 不同距离使用不同分辨率
4. **地形分块**: 大地图分割为Chunk

---

## 代码规范

### 命名约定
- 类名: PascalCase
- 接口: I前缀
- 私有字段: camelCase
- 属性: PascalCase

### 注释规范
使用XML文档注释（`/// <summary>`）

---

## 依赖管理

### Unity官方包
- Universal RP
- Mathematics
- Collections
- Burst
- Test Framework

### 第三方库（可选）
- Newtonsoft.Json
- Odin Inspector（付费）

---

## 可移植性检查清单

开发时确保：
- [ ] Core层代码不直接引用UnityEngine
- [ ] 引擎操作通过接口
- [ ] 数据使用纯C#类型
- [ ] 文件格式使用标准JSON
- [ ] UI逻辑与业务逻辑分离
